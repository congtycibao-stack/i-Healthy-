<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Kết Quả (Chuẩn File Bệnh Viện)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; text-align: center; padding-top: 15%; color: white; }
    </style>
</head>
<body class="bg-light">

    <div id="loadingOverlay" class="loading-overlay">
        <h3 class="fw-bold mb-3 text-warning"><i class="bi bi-database-fill-up bi-spin"></i> ĐANG XỬ LÝ...</h3>
        <p class="fs-5" id="lblStatus">Vui lòng chờ...</p>
    </div>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <h3 class="text-primary fw-bold"><i class="bi bi-file-earmark-excel-fill"></i> NHẬP KẾT QUẢ KHÁM</h3>
            <a href="index.html" class="btn btn-outline-secondary fw-bold"><i class="bi bi-house-door-fill"></i> VỀ TRANG CHỦ</a>
        </div>

        <div class="card shadow-sm mb-4 border-primary">
            <div class="card-body">
                <label class="fw-bold mb-2">Chọn Đợt Khám để nhập liệu:</label>
                <select id="selDotKham" class="form-select form-select-lg fw-bold text-primary"></select>
            </div>
        </div>

        <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active fw-bold" id="dk-tab" data-bs-toggle="tab" data-bs-target="#dk-pane" type="button">1. KẾT QUẢ ĐỊNH KỲ (31 CỘT)</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold text-danger" id="bnn-tab" data-bs-toggle="tab" data-bs-target="#bnn-pane" type="button">2. KẾT QUẢ BNN (25 CỘT)</button>
            </li>
        </ul>

        <div class="tab-content bg-white p-4 border rounded shadow-sm">
            
            <div class="tab-pane fade show active" id="dk-pane">
                <div class="row g-4">
                    <div class="col-md-5 border-end">
                        <h5 class="text-success fw-bold"><i class="bi bi-file-earmark-arrow-down"></i> Bước A: Tải File Mẫu Trống</h5>
                        <p class="small text-muted">File chỉ chứa tiêu đề cột (Mạch, HA, Nội, Ngoại, Máu...). Bạn copy dữ liệu từ bệnh viện vào đây.</p>
                        <button class="btn btn-outline-success w-100 py-2 fw-bold" onclick="taiMauTrong('DK')">
                            <i class="bi bi-download"></i> TẢI MẪU TRỐNG (ĐỊNH KỲ)
                        </button>
                    </div>
                    <div class="col-md-7">
                        <h5 class="text-primary fw-bold"><i class="bi bi-file-earmark-arrow-up"></i> Bước B: Upload Dữ Liệu</h5>
                        <p class="small text-muted">Hệ thống sẽ khớp theo cột <b>SỐ THẺ</b>.</p>
                        <input type="file" id="fileDK" class="form-control mb-3" accept=".xlsx, .xls">
                        <button class="btn btn-success w-100 py-2 fw-bold" onclick="uploadData('DK')">
                            <i class="bi bi-cloud-upload"></i> NẠP DỮ LIỆU ĐỊNH KỲ
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="bnn-pane">
                <div class="row g-4">
                    <div class="col-md-5 border-end">
                        <h5 class="text-danger fw-bold"><i class="bi bi-file-earmark-arrow-down"></i> Bước A: Tải File Mẫu Trống</h5>
                        <p class="small text-muted">File chứa tiêu đề cột đo đạc BNN (TP 1000, FVC, FEV1...).</p>
                        <button class="btn btn-outline-danger w-100 py-2 fw-bold" onclick="taiMauTrong('BNN')">
                            <i class="bi bi-download"></i> TẢI MẪU TRỐNG (BNN)
                        </button>
                    </div>
                    <div class="col-md-7">
                        <h5 class="text-danger fw-bold"><i class="bi bi-file-earmark-arrow-up"></i> Bước B: Upload Dữ Liệu</h5>
                        <p class="small text-muted">Hệ thống sẽ khớp theo cột <b>SỐ THẺ</b>.</p>
                        <input type="file" id="fileBNN" class="form-control mb-3" accept=".xlsx, .xls">
                        <button class="btn btn-danger w-100 py-2 fw-bold" onclick="uploadData('BNN')">
                            <i class="bi bi-cloud-upload"></i> NẠP DỮ LIỆU BNN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH ---
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);

        // --- KHỞI ĐỘNG ---
        async function init() {
            const { data } = await supabaseClient.from('dot_kham').select('*').order('id', {ascending: false});
            const sel = document.getElementById('selDotKham');
            data?.forEach(d => { 
                let opt = document.createElement('option'); 
                opt.value = d.id; 
                opt.text = d.ten_dot; 
                sel.add(opt); 
            });
        }
        init();

        // --- 1. TẢI FILE MẪU TRỐNG (CHỈ CÓ TIÊU ĐỀ) ---
        function taiMauTrong(type) {
            let exportData = [];
            
            if(type === 'DK') {
                // Header Khám Định Kỳ (31 cột)
                exportData = [{
                    "STT": "", "SỐ THẺ": "", "HỌ VÀ TÊN": "", "ĐƠN VỊ": "", "GIỚI TÍNH": "", "NĂM SINH": "", "CÔNG ĐOẠN": "",
                    "Chiều cao": "", "Cân nặng": "", "BMI": "", "Mạch (L/P)": "", "Huyết áp (mmHG)": "",
                    "Nội khoa": "", "Ngoại khoa": "", "Da liễu": "", "Lâm sàng Sản/phụ khoa": "", "XN Pap smear": "",
                    "Mắt phải": "", "Mắt trái": "", "Bệnh lý vể mắt": "",
                    "Tai mũi họng": "", "Răng hàm mặt": "", "Siêu âm tuyến vú": "", "X-Quang Chest X-Ray": "",
                    "- Dòng bạch cầu (WBC)": "", "- Dòng hồng cầu (RBC)": "", "- Dòng tiểu cầu (PLT)": "",
                    "Xếp loại": "", "Kết luận": "", "Ghi chú": ""
                }];
            } else {
                // Header Khám BNN (25 cột)
                exportData = [{
                    "STT": "", "SỐ THẺ": "", "HỌ VÀ TÊN": "", "ĐƠN VỊ": "", "GIỚI TÍNH": "", "NĂM SINH": "", "NGÀY VÀO": "", "CÔNG ĐOẠN": "",
                    "TP 1000": "", "TP 4000": "", "TT 1000": "", "TT 4000": "", "Kết Quả TL": "",
                    "FVC (lít) đo": "", "FVC (lít) lý thuyết": "", "% FVC": "", 
                    "FEV1 (lít) đo": "", "FEV1 (lít) lý thuyết": "", "% FEV1": "", 
                    "FEV1/FVC đo": "", "FEV1/FVC lý thuyết": "", "Kết quả HH": ""
                }];
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, "MauNhapLieu");
            XLSX.writeFile(wb, `Mau_Nhap_${type}_Trong.xlsx`);
        }

        // --- 2. UPLOAD DỮ LIỆU ---
        async function uploadData(type) {
            const dotId = document.getElementById('selDotKham').value;
            const fileInput = document.getElementById(type === 'DK' ? 'fileDK' : 'fileBNN');
            const file = fileInput.files[0];
            if(!dotId || !file) return Swal.fire('Thiếu thông tin', 'Chọn đợt và file Excel.', 'warning');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet); // Đọc dạng Object

                if(rows.length === 0) return Swal.fire('Lỗi', 'File trống', 'error');

                document.getElementById('loadingOverlay').style.display = 'block';
                document.getElementById('lblStatus').innerText = `Đang xử lý ${rows.length} dòng...`;

                let updateData = [];
                
                rows.forEach(r => {
                    // Tìm key Mã NV
                    const maNV = r['SỐ THẺ'] || r['Mã NV'] || r['Số thẻ'];
                    if(!maNV) return; 

                    let item = { ma_nv: maNV.toString().trim(), dot_kham_id: dotId };

                    if(type === 'DK') {
                        // MAP 31 CỘT ĐỊNH KỲ
                        item.chieu_cao = r['Chiều cao']; item.can_nang = r['Cân nặng']; item.bmi = r['BMI'];
                        item.mach = r['Mạch (L/P)']; item.huyet_ap = r['Huyết áp (mmHG)'];
                        item.noi_khoa = r['Nội khoa']; item.ngoai_khoa = r['Ngoại khoa']; item.da_lieu = r['Da liễu'];
                        item.san_phu_khoa = r['Lâm sàng Sản/phụ khoa']; item.pap_smear = r['XN Pap smear'];
                        item.thi_luc_mat_phai = r['Mắt phải']; item.thi_luc_mat_trai = r['Mắt trái']; item.benh_ve_mat = r['Bệnh lý vể mắt'];
                        item.tai_mui_hong = r['Tai mũi họng']; item.rang_ham_mat = r['Răng hàm mặt'];
                        item.sieu_am = r['Siêu âm tuyến vú']; item.x_quang = r['X-Quang Chest X-Ray'];
                        item.bach_cau = r['- Dòng bạch cầu (WBC)']; 
                        item.hong_cau = r['- Dòng hồng cầu (RBC)']; 
                        item.tieu_cau = r['- Dòng tiểu cầu (PLT)'];
                        
                        item.xep_loai = r['Xếp loại']; 
                        item.ket_luan_benh = r['Kết luận']; 
                        item.ghi_chu = r['Ghi chú'];
                    } else {
                        // MAP 25 CỘT BNN (Gom vào JSON để gọn Database)
                        const chiTietTL = { 
                            tp1: r['TP 1000'], tp4: r['TP 4000'], 
                            tt1: r['TT 1000'], tt4: r['TT 4000'] 
                        };
                        const chiTietHH = { 
                            fvc_do: r['FVC (lít) đo'], fvc_lt: r['FVC (lít) lý thuyết'], fvc_pct: r['% FVC'], 
                            fev1_do: r['FEV1 (lít) đo'], fev1_lt: r['FEV1 (lít) lý thuyết'], fev1_pct: r['% FEV1'],
                            fev1_fvc_do: r['FEV1/FVC đo'], fev1_fvc_lt: r['FEV1/FVC lý thuyết']
                        };
                        
                        item.do_thinh_luc_chi_tiet = chiTietTL;
                        item.do_ho_hap_chi_tiet = chiTietHH;
                        item.ket_qua_thinh_luc = r['Kết Quả TL'];
                        item.ket_qua_ho_hap = r['Kết quả HH'];
                    }
                    updateData.push(item);
                });

                // Batch Upsert
                let successCount = 0; const BATCH = 500;
                for(let i=0; i<updateData.length; i+=BATCH) {
                    const batch = updateData.slice(i, i+BATCH);
                    const { error } = await supabaseClient.from('ho_so_kham').upsert(batch, { onConflict: 'ma_nv, dot_kham_id' });
                    if(!error) successCount += batch.length;
                    document.getElementById('lblStatus').innerText = `Đã lưu ${successCount} / ${updateData.length}...`;
                }

                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire('Thành công', `Đã nhập xong kết quả cho ${successCount} nhân viên!`, 'success');
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>