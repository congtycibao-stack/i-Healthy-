<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Kết Quả (Smart Check) - HSE CiBao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; text-align: center; padding-top: 15%; color: white; }
    </style>
</head>
<body class="bg-light">

    <div id="loadingOverlay" class="loading-overlay">
        <h3 class="fw-bold mb-3 text-warning"><i class="bi bi-database-fill-up bi-spin"></i> ĐANG XỬ LÝ...</h3>
        <p class="fs-5" id="lblStatus">Vui lòng chờ...</p>
    </div>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <h3 class="text-primary fw-bold"><i class="bi bi-file-earmark-excel-fill"></i> NHẬP KẾT QUẢ & ĐỐI CHIẾU</h3>
            <a href="index.html" class="btn btn-outline-secondary fw-bold"><i class="bi bi-house-door-fill"></i> VỀ TRANG CHỦ</a>
        </div>

        <div class="card shadow-sm mb-4 border-primary">
            <div class="card-body">
                <label class="fw-bold mb-2">Chọn Đợt Khám:</label>
                <div class="d-flex gap-2">
                    <select id="selDotKham" class="form-select form-select-lg fw-bold text-primary border-primary"></select>
                    <button class="btn btn-info text-white fw-bold" onclick="kiemTraDoiChieu()">
                        <i class="bi bi-search"></i> Kiểm Tra Lại
                    </button>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active fw-bold" id="dk-tab" data-bs-toggle="tab" data-bs-target="#dk-pane" type="button">1. KẾT QUẢ ĐỊNH KỲ</button></li>
            <li class="nav-item"><button class="nav-link fw-bold text-danger" id="bnn-tab" data-bs-toggle="tab" data-bs-target="#bnn-pane" type="button">2. KẾT QUẢ BNN</button></li>
        </ul>

        <div class="tab-content bg-white p-4 border rounded shadow-sm">
            <div class="tab-pane fade show active" id="dk-pane">
                <div class="row g-4">
                    <div class="col-md-5 border-end">
                        <button class="btn btn-outline-success w-100 py-2 fw-bold mb-2" onclick="taiMauTrong('DK')"><i class="bi bi-download"></i> TẢI MẪU TRỐNG (ĐỊNH KỲ)</button>
                        <small class="text-muted">Dùng mẫu này để copy dữ liệu từ bệnh viện vào.</small>
                    </div>
                    <div class="col-md-7">
                        <input type="file" id="fileDK" class="form-control mb-3" accept=".xlsx, .xls">
                        <button class="btn btn-success w-100 py-2 fw-bold" onclick="uploadData('DK')"><i class="bi bi-cloud-upload"></i> NẠP DỮ LIỆU ĐỊNH KỲ</button>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="bnn-pane">
                <div class="row g-4">
                    <div class="col-md-5 border-end">
                        <button class="btn btn-outline-danger w-100 py-2 fw-bold mb-2" onclick="taiMauTrong('BNN')"><i class="bi bi-download"></i> TẢI MẪU TRỐNG (BNN)</button>
                         <small class="text-muted">Dùng mẫu này để nhập kết quả đo Thính lực/Hô hấp.</small>
                    </div>
                    <div class="col-md-7">
                        <input type="file" id="fileBNN" class="form-control mb-3" accept=".xlsx, .xls">
                        <button class="btn btn-danger w-100 py-2 fw-bold" onclick="uploadData('BNN')"><i class="bi bi-cloud-upload"></i> NẠP DỮ LIỆU BNN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDoiChieu" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-clipboard-check"></i> BÁO CÁO ĐỐI CHIẾU SAU NHẬP LIỆU</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-danger mb-3">
                                <div class="card-header bg-danger text-white fw-bold">1. NGHI VẤN (Có KQ mà CHƯA Check-in)</div>
                                <div class="card-body">
                                    <p class="small">Những người này có file kết quả nhưng hệ thống ghi nhận chưa đi khám. Cần kiểm tra xem có đi khám chui không?</p>
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-striped">
                                            <thead><tr><th>Mã NV</th><th>Họ Tên</th></tr></thead>
                                            <tbody id="tblGhost"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning mb-3">
                                <div class="card-header bg-warning text-dark fw-bold">2. THIẾU KẾT QUẢ (Đã Check-in mà chưa có KQ)</div>
                                <div class="card-body">
                                    <p class="small">Những người này đã đi khám (có check-in) nhưng chưa thấy kết quả trong file vừa nạp.</p>
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-striped">
                                            <thead><tr><th>Mã NV</th><th>Họ Tên</th></tr></thead>
                                            <tbody id="tblMissingResult"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);

        async function init() {
            const { data } = await supabaseClient.from('dot_kham').select('*').order('id', {ascending: false});
            const sel = document.getElementById('selDotKham');
            data?.forEach(d => { let opt = document.createElement('option'); opt.value = d.id; opt.text = d.ten_dot; sel.add(opt); });
        }
        init();

        function taiMauTrong(type) {
            let exportData = [];
            if(type === 'DK') {
                exportData = [{"STT": "","SỐ THẺ": "","HỌ VÀ TÊN": "","ĐƠN VỊ": "","GIỚI TÍNH": "","NĂM SINH": "","CÔNG ĐOẠN": "","Chiều cao": "","Cân nặng": "","BMI": "","Mạch (L/P)": "","Huyết áp (mmHG)": "","Nội khoa": "","Ngoại khoa": "","Da liễu": "","Lâm sàng Sản/phụ khoa": "","XN Pap smear": "","Mắt phải": "","Mắt trái": "","Bệnh lý vể mắt": "","Tai mũi họng": "","Răng hàm mặt": "","Siêu âm tuyến vú": "","X-Quang Chest X-Ray": "","- Dòng bạch cầu (WBC)": "","- Dòng hồng cầu (RBC)": "","- Dòng tiểu cầu (PLT)": "","Xếp loại": "","Kết luận": "","Ghi chú": ""}];
            } else {
                exportData = [{"STT": "","SỐ THẺ": "","HỌ VÀ TÊN": "","ĐƠN VỊ": "","GIỚI TÍNH": "","NĂM SINH": "","NGÀY VÀO": "","CÔNG ĐOẠN": "","TP 1000": "","TP 4000": "","TT 1000": "","TT 4000": "","Kết Quả TL": "","FVC (lít) đo": "","FVC (lít) lý thuyết": "","% FVC": "","FEV1 (lít) đo": "","FEV1 (lít) lý thuyết": "","% FEV1": "","FEV1/FVC đo": "","FEV1/FVC lý thuyết": "","Kết quả HH": ""}];
            }
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData), "MauNhapLieu");
            XLSX.writeFile(wb, `Mau_Nhap_${type}_Trong.xlsx`);
        }

        async function uploadData(type) {
            const dotId = document.getElementById('selDotKham').value;
            const fileInput = document.getElementById(type === 'DK' ? 'fileDK' : 'fileBNN');
            const file = fileInput.files[0];
            if(!dotId || !file) return Swal.fire('Thiếu thông tin', 'Chọn đợt và file Excel.', 'warning');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                if(rows.length === 0) return Swal.fire('Lỗi', 'File trống', 'error');
                
                document.getElementById('loadingOverlay').style.display = 'block';
                document.getElementById('lblStatus').innerText = `Đang xử lý ${rows.length} dòng...`;

                let updateData = [];
                let uploadedMaNVs = []; // Lưu danh sách mã NV vừa nạp để đối chiếu

                rows.forEach(r => {
                    const maNV = r['SỐ THẺ'] || r['Mã NV'] || r['MA_NV'] || r['Số thẻ'];
                    if(!maNV) return; 
                    const maStr = maNV.toString().trim();
                    uploadedMaNVs.push(maStr);

                    let item = { ma_nv: maStr, dot_kham_id: dotId };

                    if(type === 'DK') {
                        item.chieu_cao = r['Chiều cao']; item.can_nang = r['Cân nặng']; item.bmi = r['BMI'];
                        item.mach = r['Mạch (L/P)']; item.huyet_ap = r['Huyết áp (mmHG)'];
                        item.noi_khoa = r['Nội khoa']; item.ngoai_khoa = r['Ngoại khoa']; item.da_lieu = r['Da liễu'];
                        item.san_phu_khoa = r['Lâm sàng Sản/phụ khoa']; item.pap_smear = r['XN Pap smear'];
                        item.thi_luc_mat_phai = r['Mắt phải']; item.thi_luc_mat_trai = r['Mắt trái']; item.benh_ve_mat = r['Bệnh lý vể mắt'];
                        item.tai_mui_hong = r['Tai mũi họng']; item.rang_ham_mat = r['Răng hàm mặt'];
                        item.sieu_am = r['Siêu âm tuyến vú']; item.x_quang = r['X-Quang Chest X-Ray'];
                        item.bach_cau = r['- Dòng bạch cầu (WBC)']; item.hong_cau = r['- Dòng hồng cầu (RBC)']; item.tieu_cau = r['- Dòng tiểu cầu (PLT)'];
                        item.xep_loai = r['Xếp loại']; item.ket_luan_benh = r['Kết luận']; item.ghi_chu = r['Ghi chú'];
                    } else {
                        const chiTietTL = { tp1: r['TP 1000'], tp4: r['TP 4000'], tt1: r['TT 1000'], tt4: r['TT 4000'] };
                        const chiTietHH = { fvc_do: r['FVC (lít) đo'], fvc_lt: r['FVC (lít) lý thuyết'], fvc_pct: r['% FVC'], fev1_do: r['FEV1 (lít) đo'], fev1_lt: r['FEV1 (lít) lý thuyết'], fev1_pct: r['% FEV1'], fev1_fvc_do: r['FEV1/FVC đo'], fev1_fvc_lt: r['FEV1/FVC lý thuyết'] };
                        item.do_thinh_luc_chi_tiet = chiTietTL; item.do_ho_hap_chi_tiet = chiTietHH;
                        item.ket_qua_thinh_luc = r['Kết Quả TL']; item.ket_qua_ho_hap = r['Kết quả HH'];
                    }
                    updateData.push(item);
                });

                // Batch Upsert
                const BATCH = 500;
                for(let i=0; i<updateData.length; i+=BATCH) {
                    const batch = updateData.slice(i, i+BATCH);
                    await supabaseClient.from('ho_so_kham').upsert(batch, { onConflict: 'ma_nv, dot_kham_id' });
                }

                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire({
                    title: 'Đã nạp xong!',
                    text: 'Bạn có muốn kiểm tra đối chiếu dữ liệu ngay không?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'Kiểm tra ngay'
                }).then((r) => {
                    if(r.isConfirmed) kiemTraDoiChieu();
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 3. TÍNH NĂNG MỚI: KIỂM TRA ĐỐI CHIẾU ---
        async function kiemTraDoiChieu() {
            const dotId = document.getElementById('selDotKham').value;
            if(!dotId) return;

            document.getElementById('loadingOverlay').style.display = 'block';
            document.getElementById('lblStatus').innerText = "Đang đối chiếu dữ liệu...";

            // Lấy toàn bộ dữ liệu (Chỉ cần mã NV, tên, checkin, kết quả)
            let allData = [];
            let offset = 0; const PAGE = 2000; let keep = true;
            while(keep) {
                const { data } = await supabaseClient.from('ho_so_kham')
                    .select('ma_nv, trang_thai_checkin, xep_loai, ket_qua_thinh_luc, ket_qua_ho_hap, nhan_vien(ho_ten)')
                    .eq('dot_kham_id', dotId).range(offset, offset + PAGE - 1);
                if(data && data.length > 0) { allData = allData.concat(data); offset += PAGE; if(data.length < PAGE) keep = false; } else keep = false;
            }

            // Phân loại
            let ghosts = []; // Có KQ mà chưa Checkin
            let missingResult = []; // Checkin rồi mà chưa có KQ (Xét theo tab hiện tại)
            
            // Xác định đang ở Tab nào để check cột tương ứng
            const isDK = document.getElementById('dk-tab').classList.contains('active');

            allData.forEach(item => {
                const hasResult = isDK ? (item.xep_loai) : (item.ket_qua_thinh_luc || item.ket_qua_ho_hap);
                const isCheckedIn = item.trang_thai_checkin;

                if (hasResult && !isCheckedIn) {
                    ghosts.push(item);
                } else if (isCheckedIn && !hasResult) {
                    missingResult.push(item);
                }
            });

            // Render ra bảng
            const tblGhost = document.getElementById('tblGhost');
            const tblMiss = document.getElementById('tblMissingResult');
            tblGhost.innerHTML = ''; tblMiss.innerHTML = '';

            ghosts.forEach(i => {
                tblGhost.innerHTML += `<tr><td>${i.ma_nv}</td><td>${i.nhan_vien?.ho_ten}</td></tr>`;
            });
            missingResult.forEach(i => {
                tblMiss.innerHTML += `<tr><td>${i.ma_nv}</td><td>${i.nhan_vien?.ho_ten}</td></tr>`;
            });

            document.getElementById('loadingOverlay').style.display = 'none';
            new bootstrap.Modal(document.getElementById('modalDoiChieu')).show();
        }
    </script>
</body>
</html>