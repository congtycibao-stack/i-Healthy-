<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cấu Hình Hệ Thống - HSE CiBao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary fw-bold"><i class="bi bi-gear-wide-connected"></i> QUẢN TRỊ HỆ THỐNG</h2>
            <a href="index.html" class="btn btn-outline-secondary"><i class="bi bi-house"></i> Về Trang Chủ</a>
        </div>

        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill"></i> <b>Lưu ý quan trọng:</b> Hệ thống sẽ tự động thêm số '0' vào trước các Mã Đơn vị nếu thiếu (Ví dụ: <b>12</b> -> <b>012</b>) để đảm bảo chuẩn 3 ký tự.
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100 border-primary">
                    <div class="card-header bg-primary text-white fw-bold">1. DANH MỤC ĐƠN VỊ / BỘ PHẬN</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="file" id="fileDonVi" class="form-control" accept=".xlsx, .xls">
                            <button class="btn btn-primary" onclick="uploadMaster('DONVI')">Nạp Đơn Vị</button>
                        </div>
                        <div class="fw-bold text-success" id="statDonVi">...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm h-100 border-success">
                    <div class="card-header bg-success text-white fw-bold">2. DANH MỤC CHỨC VỤ</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="file" id="fileChucVu" class="form-control" accept=".xlsx, .xls">
                            <button class="btn btn-success" onclick="uploadMaster('CHUCVU')">Nạp Chức Vụ</button>
                        </div>
                        <div class="fw-bold text-success" id="statChucVu">...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100 border-danger">
                    <div class="card-header bg-danger text-white fw-bold">3. CÔNG ĐOẠN & ĐỘC HẠI</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="file" id="fileCongDoan" class="form-control" accept=".xlsx, .xls">
                            <button class="btn btn-danger" onclick="uploadMaster('CONGDOAN')">Nạp Công Đoạn</button>
                        </div>
                        <div class="fw-bold text-success" id="statCongDoan">...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm h-100 border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">4. CẤU HÌNH KHÁM BNN</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="file" id="fileCauHinh" class="form-control" accept=".xlsx, .xls">
                            <button class="btn btn-warning" onclick="uploadMaster('CAUHINH')">Nạp Cấu Hình</button>
                        </div>
                        <div class="fw-bold text-success" id="statCauHinh">...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);

        async function checkStats() {
            const t1 = supabaseClient.from('danh_muc_don_vi').select('*', { count: 'exact', head: true });
            const t2 = supabaseClient.from('danh_muc_chuc_vu').select('*', { count: 'exact', head: true });
            const t3 = supabaseClient.from('danh_muc_cong_doan').select('*', { count: 'exact', head: true });
            const t4 = supabaseClient.from('cau_hinh_kham').select('*', { count: 'exact', head: true });
            const [r1, r2, r3, r4] = await Promise.all([t1, t2, t3, t4]);
            
            document.getElementById('statDonVi').innerText = `Đang có: ${r1.count || 0} ĐV`;
            document.getElementById('statChucVu').innerText = `Đang có: ${r2.count || 0} CV`;
            document.getElementById('statCongDoan').innerText = `Đang có: ${r3.count || 0} CĐ`;
            document.getElementById('statCauHinh').innerText = `Đang có: ${r4.count || 0} CH`;
        }
        checkStats();

        async function uploadMaster(type) {
            let fileInputId = '';
            let tableName = '';
            
            if (type === 'DONVI') { fileInputId = 'fileDonVi'; tableName = 'danh_muc_don_vi'; }
            else if (type === 'CHUCVU') { fileInputId = 'fileChucVu'; tableName = 'danh_muc_chuc_vu'; }
            else if (type === 'CONGDOAN') { fileInputId = 'fileCongDoan'; tableName = 'danh_muc_cong_doan'; }
            else if (type === 'CAUHINH') { fileInputId = 'fileCauHinh'; tableName = 'cau_hinh_kham'; }

            const file = document.getElementById(fileInputId).files[0];
            if(!file) return Swal.fire('Lỗi', 'Chưa chọn file!', 'error');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

                const dataToSave = [];
                for(let i=1; i<rows.length; i++) {
                    const r = rows[i];
                    if(!r[0]) continue;

                    // --- LOGIC XỬ LÝ SỐ 0 Ở ĐẦU (PADSTART) ---
                    // Hàm chuẩn hóa mã: Nếu là số thì chuyển thành chuỗi và thêm số 0 cho đủ 3 ký tự
                    const chuanHoaMa = (val) => {
                        if (!val) return "";
                        // Nếu là ĐƠN VỊ và giá trị là số (hoặc chuỗi số ngắn), ta ép về 3 ký tự
                        // Ví dụ: 12 -> "012", "1" -> "001"
                        if (type === 'DONVI') {
                             return val.toString().trim().padStart(3, '0');
                        }
                        return val.toString().trim();
                    };

                    let item = {};
                    if (type === 'DONVI') {
                        item = { ma_don_vi: chuanHoaMa(r[0]), ten_don_vi: r[1] || '' };
                    } 
                    else if (type === 'CHUCVU') {
                        item = { ma_chuc_vu: r[0].toString().trim(), ten_chuc_vu: r[1] || '' };
                    }
                    else if (type === 'CONGDOAN') {
                        let docHai = false;
                        if(r[2] === true || r[2] === 'TRUE' || r[2] === 'Y' || r[2] === 'Yes') docHai = true;
                        item = { ma_cong_doan: r[0].toString().trim(), ten_cong_doan: r[1] || '', co_doc_hai: docHai };
                    }
                    else if (type === 'CAUHINH') {
                        let chiDinh = {};
                        try { chiDinh = JSON.parse(r[2] || '{}'); } catch(e) {}
                        item = { ma_cong_doan: r[0].toString().trim(), tan_suat_kham: r[1] || '1 lần/năm', chi_dinh_bnn: chiDinh };
                    }
                    dataToSave.push(item);
                }

                if(dataToSave.length === 0) return Swal.fire('Lỗi', 'File trống', 'warning');

                Swal.fire({title: 'Đang lưu...', didOpen: ()=>Swal.showLoading()});
                const { error } = await supabaseClient.from(tableName).upsert(dataToSave);

                if(error) Swal.fire('Lỗi', error.message, 'error');
                else {
                    Swal.fire('Thành công', `Đã nạp ${dataToSave.length} dòng.`, 'success');
                    checkStats();
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>