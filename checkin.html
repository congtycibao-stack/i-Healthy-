<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trạm Check-in HSE (Pro)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #e9ecef; height: 100vh; overflow: hidden; }
        .left-panel { background: white; height: 100vh; padding: 30px; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        .scan-input { font-size: 2rem; text-align: center; letter-spacing: 3px; font-weight: bold; border: 3px solid #0d6efd; border-radius: 10px; height: 70px; }
        .right-panel { padding: 30px; height: 100vh; overflow-y: auto; }
        .result-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 10px solid #ccc; transition: all 0.3s; }
        .result-card.success { border-left-color: #198754; } 
        .result-card.toxic { border-left-color: #dc3545; }
        .big-name { font-size: 2.2rem; font-weight: bold; color: #333; }
        .info-row { font-size: 1.1rem; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .info-label { font-weight: bold; color: #666; width: 140px; display: inline-block; }
        .stat-box { background: #0d6efd; color: white; border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 10px; }
        .stat-num { font-size: 2rem; font-weight: bold; line-height: 1; }
        .stat-label { font-size: 0.8rem; opacity: 0.9; }
        .badge-xl { font-size: 1.2rem; padding: 10px 20px; border-radius: 30px; }
    </style>
</head>
<body>
    <div class="row g-0">
        <div class="col-md-5 col-lg-4 left-panel shadow">
            <div class="mb-3 text-center">
                <a href="index.html" class="btn btn-outline-secondary btn-sm mb-2"><i class="bi bi-arrow-left"></i> Home</a>
                <h4 class="fw-bold text-primary">TRẠM CHECK-IN</h4>
                <div id="lblDotKham" class="badge bg-warning text-dark px-3 py-2 fs-6">Đang tải...</div>
            </div>

            <div class="mb-4">
                <input type="text" id="txtMaNV" class="form-control scan-input" placeholder="NV..." autocomplete="off">
                <div class="text-center mt-2 small text-muted">Quét thẻ nhân viên</div>
            </div>

            <div class="mt-auto">
                <div class="row g-2">
                    <div class="col-4">
                        <div class="stat-box" style="background: #198754;">
                            <div class="stat-num" id="cntToday">0</div>
                            <div class="stat-label">Hôm nay</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-box" style="background: #0d6efd;">
                            <div class="stat-num" id="cntTotal">0</div>
                            <div class="stat-label">Đã Khám</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-box" style="background: #dc3545;">
                            <div class="stat-num" id="cntMissing">0</div>
                            <div class="stat-label">Chưa khám</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline-danger w-100 mt-2 fw-bold" onclick="taiDSChuaKham()">
                    <i class="bi bi-download"></i> TẢI DS CHƯA KHÁM (ĐI HỐI)
                </button>
            </div>
        </div>

        <div class="col-md-7 col-lg-8 right-panel">
            <div id="resultContainer" style="display: none;">
                <div class="result-card" id="mainCard">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="big-name" id="uiName">NGUYỄN VĂN A</div>
                            <div class="text-muted fs-5 mb-3"><i class="bi bi-upc-scan"></i> <span id="uiID">CB001</span></div>
                        </div>
                        <div id="uiStatusBadge"></div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="info-row"><span class="info-label">Đơn vị:</span> <span id="uiDonVi">-</span></div>
                            <div class="info-row"><span class="info-label">Chức vụ:</span> <span id="uiChucVu">-</span></div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-row"><span class="info-label">Công đoạn:</span> <span id="uiCongDoan" class="fw-bold text-primary">-</span></div>
                            <div class="mt-3 p-3 bg-light rounded border">
                                <h6 class="fw-bold text-decoration-underline">CHẾ ĐỘ KHÁM:</h6>
                                <div id="uiCanhBao"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h6 class="text-muted fw-bold mt-4 mb-3 border-bottom pb-2">LỊCH SỬ QUÉT GẦN NHẤT</h6>
            <div id="recentList"></div>
        </div>
    </div>

    <audio id="soundOK" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
    <audio id="soundError" src="https://www.soundjay.com/buttons/sounds/beep-02.mp3"></audio>
    <audio id="soundToxic" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3"></audio>

    <script>
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);

        let currentDotId = null;
        let masterCongDoan = {}; let masterCauHinh = {};

        async function init() {
            const { data: dot } = await supabaseClient.from('dot_kham').select('*').order('id', {ascending: false}).limit(1).single();
            if (dot) {
                currentDotId = dot.id;
                document.getElementById('lblDotKham').innerText = dot.ten_dot;
                updateStats();
                loadMasterData();
            } else {
                document.getElementById('lblDotKham').innerText = "CHƯA CÓ ĐỢT";
                document.getElementById('lblDotKham').className = "badge bg-danger";
            }
            document.getElementById('txtMaNV').focus();
        }

        async function loadMasterData() {
            const [resCD, resCH] = await Promise.all([
                supabaseClient.from('danh_muc_cong_doan').select('*'),
                supabaseClient.from('cau_hinh_kham').select('*')
            ]);
            if(resCD.data) resCD.data.forEach(x => masterCongDoan[x.ma_cong_doan] = x);
            if(resCH.data) resCH.data.forEach(x => masterCauHinh[x.ma_cong_doan] = x);
        }

        document.getElementById('txtMaNV').addEventListener("keypress", function(event) {
            if (event.key === "Enter") { event.preventDefault(); checkIn(); }
        });

        async function checkIn() {
            const maNV = document.getElementById('txtMaNV').value.trim().toUpperCase();
            if(!maNV) return;
            document.getElementById('txtMaNV').value = ''; document.getElementById('txtMaNV').focus();
            if(!currentDotId) return;

            try {
                const { data: nv } = await supabaseClient.from('nhan_vien').select('*').eq('ma_nv', maNV).single();
                if (!nv) { playSound('error'); return Swal.fire({ icon: 'error', title: 'Không tìm thấy!', timer: 1000, showConfirmButton: false }); }

                let isDocHai = false; let canhBaoArr = [];
                if(nv.ma_cong_doan) {
                    if(masterCongDoan[nv.ma_cong_doan]?.co_doc_hai) { isDocHai = true; canhBaoArr.push('<span class="badge bg-danger">ĐỘC HẠI</span>'); }
                    const cd = masterCauHinh[nv.ma_cong_doan]?.chi_dinh_bnn;
                    if(cd?.tl) canhBaoArr.push('<span class="badge bg-warning text-dark">Đo Thính Lực</span>');
                    if(cd?.hh) canhBaoArr.push('<span class="badge bg-info text-dark">Đo Hô Hấp</span>');
                }
                if(canhBaoArr.length === 0) canhBaoArr.push('<span class="badge bg-success">Bình thường</span>');

                await supabaseClient.from('ho_so_kham').upsert({
                    dot_kham_id: currentDotId, ma_nv: nv.ma_nv, trang_thai_checkin: true,
                    bo_phan: nv.ma_don_vi, vi_tri: nv.ma_chuc_vu,
                    phan_loai_lao_dong: isDocHai ? 'Độc hại' : 'Bình thường',
                    chi_dinh_kham: canhBaoArr.map(x => x.replace(/<[^>]*>?/gm, '')).join(', ')
                }, { onConflict: 'ma_nv, dot_kham_id' });

                displayResult(nv, isDocHai, canhBaoArr);
                playSound(isDocHai ? 'toxic' : 'ok');
                updateStats();

            } catch (err) { console.error(err); playSound('error'); }
        }

        function displayResult(nv, isDocHai, canhBaoArr) {
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('uiName').innerText = nv.ho_ten;
            document.getElementById('uiID').innerText = nv.ma_nv;
            document.getElementById('uiDonVi').innerText = nv.ma_don_vi || '-';
            document.getElementById('uiChucVu').innerText = nv.ma_chuc_vu || '-';
            document.getElementById('uiCongDoan').innerText = nv.ma_cong_doan || '-';
            document.getElementById('uiCanhBao').innerHTML = canhBaoArr.join(' ');

            const card = document.getElementById('mainCard');
            const badge = document.getElementById('uiStatusBadge');
            card.className = 'result-card ' + (isDocHai ? 'toxic' : 'success');
            badge.innerHTML = isDocHai ? '<span class="badge-xl bg-danger text-white shadow">NGUY CƠ CAO</span>' : '<span class="badge-xl bg-success text-white shadow">AN TOÀN</span>';

            const logItem = document.createElement('div');
            logItem.className = 'bg-white p-2 mb-2 rounded border-start border-4 border-primary';
            logItem.innerHTML = `<b>${nv.ma_nv}</b> - ${nv.ho_ten} <span class="text-muted float-end small">${new Date().toLocaleTimeString()}</span>`;
            document.getElementById('recentList').prepend(logItem);
        }

        async function updateStats() {
            if(!currentDotId) return;
            const today = new Date().toISOString().split('T')[0];
            
            // 1. Tổng đợt (Tất cả hồ sơ trong đợt này)
            const { count: totalPlan } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', currentDotId);
            
            // 2. Đã khám (Checkin = true)
            const { count: totalChecked } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', currentDotId).eq('trang_thai_checkin', true);
            
            // 3. Hôm nay
            const { count: todayCount } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', currentDotId).eq('trang_thai_checkin', true).gte('created_at', today + 'T00:00:00');

            document.getElementById('cntToday').innerText = todayCount || 0;
            document.getElementById('cntTotal').innerText = totalChecked || 0;
            document.getElementById('cntMissing').innerText = (totalPlan - totalChecked) || 0;
        }

        // --- NÚT TẢI DANH SÁCH ĐI HỐI ---
        async function taiDSChuaKham() {
            if(!currentDotId) return;
            Swal.fire({title: 'Đang tải danh sách...', didOpen: ()=>Swal.showLoading()});
            
            // Lấy danh sách những người chưa check-in
            const { data, error } = await supabaseClient
                .from('ho_so_kham')
                .select('ma_nv, bo_phan, vi_tri, nhan_vien(ho_ten)')
                .eq('dot_kham_id', currentDotId)
                .eq('trang_thai_checkin', false)
                .range(0, 99999); // Lấy hết

            if(error) return Swal.fire('Lỗi', error.message, 'error');
            if(!data || data.length === 0) return Swal.fire('Tuyệt vời', 'Tất cả mọi người đã khám xong!', 'success');

            const exportData = data.map(i => ({
                "Mã NV": i.ma_nv,
                "Họ Tên": i.nhan_vien?.ho_ten,
                "Bộ Phận": i.bo_phan,
                "Chức Vụ": i.vi_tri,
                "Trạng Thái": "Chưa đi khám (Cần hối)"
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DS_ChuaKham");
            XLSX.writeFile(wb, "DanhSach_DiHoi_KSK.xlsx");
            
            Swal.close();
        }

        function playSound(type) {
            let audio;
            if(type === 'ok') audio = document.getElementById('soundOK');
            else if(type === 'error') audio = document.getElementById('soundError');
            else if(type === 'toxic') audio = document.getElementById('soundToxic');
            if(audio) { audio.currentTime = 0; audio.play().catch(e=>{}); }
        }

        init();
    </script>
</body>
</html>