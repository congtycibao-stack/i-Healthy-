<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒê·ª£t Kh√°m - HSE CiBao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* CSS Giao di·ªán c≈© */
        .stat-card { border-left: 5px solid #ddd; transition: 0.3s; cursor: pointer; background: white; height: 100%; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .border-total { border-left-color: #0d6efd; }
        .border-toxic { border-left-color: #dc3545; }
        .border-bnn { border-left-color: #ffc107; }
        .border-normal { border-left-color: #198754; }
        .border-missing { border-left-color: #6c757d; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; text-align: center; padding-top: 15%; color: white; }
        
        /* CSS M·ªõi cho T√†i Ch√≠nh */
        .money-input { font-weight: bold; color: #198754; text-align: right; letter-spacing: 1px; }
        .money-input:focus { background-color: #f0fff4; border-color: #198754; box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25); }
        .total-cell { font-weight: bold; color: #dc3545; text-align: right; font-size: 1.1rem; }
        .grand-total-box { background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .currency-switch { cursor: pointer; user-select: none; }
    </style>
</head>
<body class="bg-light">

    <div id="loadingOverlay" class="loading-overlay">
        <h3 class="fw-bold mb-3 text-warning"><i class="bi bi-database-fill-gear bi-spin"></i> ƒêANG X·ª¨ L√ù...</h3>
        <p class="fs-5">Vui l√≤ng ƒë·ª£i: <span id="lblProgress" class="fw-bold text-info">...</span></p>
    </div>

    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary fw-bold"><i class="bi bi-calendar-check"></i> QU·∫¢N L√ù ƒê·ª¢T KH√ÅM</h2>
            <a href="index.html" class="btn btn-outline-secondary"><i class="bi bi-house"></i> Trang Ch·ªß</a>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-plus-circle"></i> T·∫†O ƒê·ª¢T KH√ÅM</div>
                    <div class="card-body">
                        <label class="fw-bold mb-1">T√™n ƒë·ª£t kh√°m:</label>
                        <input type="text" id="txtTenDot" class="form-control mb-3" placeholder="Vd: KSK 2026">
                        <label class="fw-bold mb-1">Ng√†y b·∫Øt ƒë·∫ßu:</label>
                        <input type="date" id="txtNgay" class="form-control mb-3">
                        <button class="btn btn-primary w-100" onclick="taoDotKham()">L∆∞u ƒê·ª£t Kh√°m</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white fw-bold"><i class="bi bi-list-ul"></i> DANH S√ÅCH</div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr><th>T√™n ƒê·ª£t</th><th>S·ªë L∆∞·ª£ng</th><th>Thao T√°c</th><th width="50">X√≥a</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCost" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-calculator"></i> D·ª∞ TO√ÅN CHI PH√ç & H·ª¢P ƒê·ªíNG</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm border">
                        <div class="d-flex align-items-center gap-3">
                            <label class="fw-bold">Lo·∫°i ti·ªÅn:</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="currency" id="currVND" autocomplete="off" checked onclick="switchCurrency('VND')">
                                <label class="btn btn-outline-success" for="currVND">üáªüá≥ VND</label>
                                
                                <input type="radio" class="btn-check" name="currency" id="currUSD" autocomplete="off" onclick="switchCurrency('USD')">
                                <label class="btn btn-outline-primary" for="currUSD">üá∫üá∏ USD</label>
                            </div>
                        </div>
                        <div id="exchangeRateBox" style="display: none;" class="d-flex align-items-center gap-2">
                            <label class="fw-bold text-primary">T·ª∑ gi√° (1 USD = ? VND):</label>
                            <input type="text" id="txtTyGia" class="form-control money-input" style="width: 150px;" value="25,400" onkeyup="formatCurrency(this); tinhTien()">
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-3">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0 align-middle">
                                <thead class="table-success">
                                    <tr>
                                        <th>H·∫°ng m·ª•c kh√°m</th>
                                        <th class="text-center">S·ªë l∆∞·ª£ng</th>
                                        <th class="text-end" style="width: 200px;">ƒê∆°n Gi√° <span id="lblUnit"></span></th>
                                        <th class="text-end">Th√†nh Ti·ªÅn <span id="lblUnitTotal"></span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-primary">1. Kh√°m ƒê·ªãnh K·ª≥ (B√¨nh th∆∞·ªùng)</div>
                                            <small class="text-muted">Nh√¢n vi√™n vƒÉn ph√≤ng, kho nh·∫π...</small>
                                        </td>
                                        <td class="text-center fw-bold fs-5" id="qtyDinhKy">0</td>
                                        <td><input type="text" id="priceDinhKy" class="form-control money-input" placeholder="0" onkeyup="formatCurrency(this); tinhTien()"></td>
                                        <td class="total-cell" id="totalDinhKy">0</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-danger">2. Kh√°m N·∫∑ng nh·ªçc / ƒê·ªôc h·∫°i</div>
                                            <small class="text-muted">C√¥ng ƒëo·∫°n Y, Z... (G√≥i kh√°m cao h∆°n)</small>
                                        </td>
                                        <td class="text-center fw-bold fs-5" id="qtyDocHai">0</td>
                                        <td><input type="text" id="priceDocHai" class="form-control money-input" placeholder="0" onkeyup="formatCurrency(this); tinhTien()"></td>
                                        <td class="total-cell" id="totalDocHai">0</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-warning text-dark">3. ƒêo Quan tr·∫Øc BNN</div>
                                            <small class="text-muted">ƒêo th√≠nh l·ª±c, h√¥ h·∫•p (T√≠nh theo l∆∞·ª£t ƒëo)</small>
                                        </td>
                                        <td class="text-center fw-bold fs-5" id="qtyBNN">0</td>
                                        <td><input type="text" id="priceBNN" class="form-control money-input" placeholder="0" onkeyup="formatCurrency(this); tinhTien()"></td>
                                        <td class="total-cell" id="totalBNN">0</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-info text-dark">4. Kh√°m Ph·ª• Khoa (N·ªØ)</div>
                                            <small class="text-muted">D√†nh cho lao ƒë·ªông N·ªØ</small>
                                        </td>
                                        <td class="text-center fw-bold fs-5" id="qtyNu">0</td>
                                        <td><input type="text" id="priceNu" class="form-control money-input" placeholder="0" onkeyup="formatCurrency(this); tinhTien()"></td>
                                        <td class="total-cell" id="totalNu">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="alert alert-info small mb-0">
                                <i class="bi bi-info-circle"></i> <b>Ghi ch√∫:</b> Nh·∫≠p ƒë∆°n gi√° theo h·ª£p ƒë·ªìng. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông nh√¢n v·ªõi s·ªë l∆∞·ª£ng th·ª±c t·∫ø trong danh s√°ch.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="grand-total-box">
                                <div class="text-uppercase small opacity-75">T·ªîNG C·ªòNG D·ª∞ KI·∫æN</div>
                                <div class="fs-2 fw-bold" id="lblGrandTotal">0</div>
                                <div id="lblSubTotal" class="small mt-1 opacity-75" style="display:none;">(Quy ƒë·ªïi: 0 VND)</div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="luuBaoGia()"><i class="bi bi-save"></i> L∆∞u C·∫•u H√¨nh Gi√°</button>
                    <button class="btn btn-outline-secondary" onclick="exportBaoGia()"><i class="bi bi-printer"></i> Xu·∫•t Excel B√°o Gi√°</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetail" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalTitle">TH·ªêNG K√ä CHI TI·∫æT</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div class="row g-3 mb-3 text-center">
                        <div class="col-md-4"><div class="card p-3 stat-card border-total"><h3 class="fw-bold text-primary" id="stTong">0</h3><div class="small fw-bold text-muted">1. T·ªîNG NH√ÇN S·ª∞</div><button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="taiDanhSach('ALL')">T·∫£i DS T·ªïng</button></div></div>
                        <div class="col-md-4"><div class="card p-3 stat-card border-toxic"><h3 class="fw-bold text-danger" id="stDocHai">0</h3><div class="small fw-bold text-muted">2. N·∫∂NG NH·ªåC ƒê·ªòC H·∫†I</div><button class="btn btn-sm btn-outline-danger mt-2 w-100" onclick="taiDanhSach('DOCHAI')">T·∫£i DS ƒê·ªôc h·∫°i</button></div></div>
                        <div class="col-md-4"><div class="card p-3 stat-card border-bnn"><h3 class="fw-bold text-warning" id="stBNN">0</h3><div class="small fw-bold text-muted">3. KH√ÅM BNN</div><button class="btn btn-sm btn-outline-warning mt-2 w-100" onclick="taiDanhSach('BNN')">T·∫£i DS BNN</button></div></div>
                    </div>
                    <div class="row g-3 text-center">
                        <div class="col-md-6"><div class="card p-3 stat-card border-normal"><h3 class="fw-bold text-success" id="stDinhKy">0</h3><div class="small fw-bold text-muted">4. CH·ªà KH√ÅM ƒê·ªäNH K·ª≤</div><button class="btn btn-sm btn-outline-success mt-2 w-100" onclick="taiDanhSach('DINHKY')">T·∫£i DS ƒê·ªãnh K·ª≥</button></div></div>
                        <div class="col-md-6"><div class="card p-3 stat-card border-missing"><h3 class="fw-bold text-secondary" id="stChuaKham">0</h3><div class="small fw-bold text-muted">5. CH∆ØA ƒêI KH√ÅM</div><button class="btn btn-sm btn-secondary mt-2 w-100" onclick="taiDanhSach('MISSING')">T·∫£i DS Ch∆∞a Kh√°m</button></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);
        let currentDotID = null;
        let currencyMode = 'VND'; // M·∫∑c ƒë·ªãnh

        // --- C√ÅC H√ÄM TI·ªÜN √çCH T√ÄI CH√çNH ---
        // 1. Format s·ªë ti·ªÅn khi nh·∫≠p (VD: 10000 -> 10,000)
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ""); // X√≥a h·∫øt k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            if (value === "") return;
            input.value = parseInt(value).toLocaleString('en-US');
        }

        // 2. L·∫•y gi√° tr·ªã s·ªë t·ª´ √¥ nh·∫≠p (X√≥a d·∫•u ph·∫©y ƒë·ªÉ t√≠nh to√°n)
        function getNumber(id) {
            const val = document.getElementById(id).value.replace(/,/g, '');
            return parseFloat(val) || 0;
        }

        // 3. ƒê·ªïi lo·∫°i ti·ªÅn
        function switchCurrency(mode) {
            currencyMode = mode;
            const exBox = document.getElementById('exchangeRateBox');
            const lblUnit = document.getElementById('lblUnit');
            const lblUnitTotal = document.getElementById('lblUnitTotal');

            if(mode === 'USD') {
                exBox.style.display = 'flex';
                lblUnit.innerText = '(USD)';
                lblUnitTotal.innerText = '(USD)';
            } else {
                exBox.style.display = 'none';
                lblUnit.innerText = '(VND)';
                lblUnitTotal.innerText = '(VND)';
            }
            tinhTien(); // T√≠nh l·∫°i ngay
        }

        // --- LOAD DANH S√ÅCH (LOGIC C≈®) ---
        async function loadDanhSach() {
            const { data: dsDot, error } = await supabaseClient.from('dot_kham').select('*').order('id', { ascending: false });
            if (error) return console.error(error);
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            for (const item of dsDot) {
                const { count } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', item.id);
                let badge = item.id === dsDot[0].id ? '<span class="badge bg-success">ƒêang ch·∫°y</span>' : '<span class="badge bg-secondary">ƒê√£ xong</span>';
                
                tbody.innerHTML += `<tr>
                    <td><span class="fw-bold text-primary">${item.ten_dot}</span><br>${badge}</td>
                    <td><span class="badge bg-light text-dark border fs-6">${count || 0}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success fw-bold" onclick="lapDanhSach(${item.id})" title="Qu√©t to√†n b·ªô nh√¢n vi√™n"><i class="bi bi-people-fill"></i> Qu√©t Full</button>
                            <button class="btn btn-sm btn-warning fw-bold text-dark" onclick="vetTuDotCu(${item.id})" title="L·∫•y ng∆∞·ªùi ch∆∞a kh√°m t·ª´ ƒë·ª£t kh√°c"><i class="bi bi-funnel-fill"></i> V√©t S√≥t</button>
                            <button class="btn btn-sm btn-primary fw-bold" onclick="xemThongKe(${item.id}, '${item.ten_dot}')" title="Xem b√°o c√°o"><i class="bi bi-file-earmark-bar-graph"></i> B√°o C√°o</button>
                            <button class="btn btn-sm btn-info fw-bold text-white" onclick="tinhChiPhi(${item.id})" title="T√≠nh ti·ªÅn"><i class="bi bi-cash-stack"></i> Chi Ph√≠</button>
                        </div>
                    </td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="xoaDot(${item.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            }
        }
        loadDanhSach();

        // --- T√çNH NƒÇNG T√çNH CHI PH√ç (C·∫¢I TI·∫æN) ---
        async function tinhChiPhi(dotId) {
            currentDotID = dotId;
            document.getElementById('loadingOverlay').style.display = 'block';

            // 1. L·∫•y s·ªë l∆∞·ª£ng
            const { count: cDocHai } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId).eq('phan_loai_lao_dong', 'ƒê·ªôc h·∫°i');
            const { count: cTong } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId);
            const { count: cBNN } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId).neq('chi_dinh_kham', '');
            
            // Check N·ªØ
            const { data: nuData } = await supabaseClient.from('ho_so_kham').select('nhan_vien!inner(gioi_tinh)').eq('dot_kham_id', dotId);
            let cNu = 0;
            if(nuData) cNu = nuData.filter(x => x.nhan_vien.gioi_tinh && (x.nhan_vien.gioi_tinh.includes('N·ªØ') || x.nhan_vien.gioi_tinh === 'F')).length;

            const cDinhKy = (cTong || 0) - (cDocHai || 0);

            // ƒêi·ªÅn s·ªë l∆∞·ª£ng
            document.getElementById('qtyDinhKy').innerText = cDinhKy.toLocaleString();
            document.getElementById('qtyDocHai').innerText = (cDocHai || 0).toLocaleString();
            document.getElementById('qtyBNN').innerText = (cBNN || 0).toLocaleString();
            document.getElementById('qtyNu').innerText = cNu.toLocaleString();

            // Load gi√° ƒë√£ l∆∞u
            const savedData = JSON.parse(localStorage.getItem(`cost_${dotId}`) || '{}');
            if(savedData.prices) {
                document.getElementById('priceDinhKy').value = savedData.prices.dk;
                document.getElementById('priceDocHai').value = savedData.prices.dh;
                document.getElementById('priceBNN').value = savedData.prices.bnn;
                document.getElementById('priceNu').value = savedData.prices.nu;
            } else {
                // Reset v·ªÅ 0 n·∫øu ch∆∞a c√≥
                ['priceDinhKy','priceDocHai','priceBNN','priceNu'].forEach(id => document.getElementById(id).value = "");
            }
            
            // Load Currency
            if(savedData.currency === 'USD') {
                document.getElementById('currUSD').checked = true;
                if(savedData.rate) document.getElementById('txtTyGia').value = savedData.rate;
                switchCurrency('USD');
            } else {
                document.getElementById('currVND').checked = true;
                switchCurrency('VND');
            }

            tinhTien();
            document.getElementById('loadingOverlay').style.display = 'none';
            new bootstrap.Modal(document.getElementById('modalCost')).show();
        }

        function tinhTien() {
            // L·∫•y ƒë∆°n gi√° (ƒë√£ b·ªè d·∫•u ph·∫©y)
            const pDK = getNumber('priceDinhKy');
            const pDH = getNumber('priceDocHai');
            const pBNN = getNumber('priceBNN');
            const pNu = getNumber('priceNu');

            // L·∫•y s·ªë l∆∞·ª£ng (ƒë√£ b·ªè d·∫•u ph·∫©y hi·ªÉn th·ªã)
            const qDK = parseInt(document.getElementById('qtyDinhKy').innerText.replace(/,/g, ''));
            const qDH = parseInt(document.getElementById('qtyDocHai').innerText.replace(/,/g, ''));
            const qBNN = parseInt(document.getElementById('qtyBNN').innerText.replace(/,/g, ''));
            const qNu = parseInt(document.getElementById('qtyNu').innerText.replace(/,/g, ''));

            // T√≠nh th√†nh ti·ªÅn
            const tDK = qDK * pDK;
            const tDH = qDH * pDH;
            const tBNN = qBNN * pBNN;
            const tNu = qNu * pNu;

            // Hi·ªÉn th·ªã th√†nh ti·ªÅn
            document.getElementById('totalDinhKy').innerText = tDK.toLocaleString('en-US');
            document.getElementById('totalDocHai').innerText = tDH.toLocaleString('en-US');
            document.getElementById('totalBNN').innerText = tBNN.toLocaleString('en-US');
            document.getElementById('totalNu').innerText = tNu.toLocaleString('en-US');

            const total = tDK + tDH + tBNN + tNu;

            // Hi·ªÉn th·ªã T·ªïng c·ªông
            if(currencyMode === 'USD') {
                // Hi·ªÉn th·ªã USD
                document.getElementById('lblGrandTotal').innerText = '$ ' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                // Quy ƒë·ªïi ra VND
                const rate = getNumber('txtTyGia');
                const totalVND = total * rate;
                const lblSub = document.getElementById('lblSubTotal');
                lblSub.style.display = 'block';
                lblSub.innerText = `(Quy ƒë·ªïi: ‚âà ${totalVND.toLocaleString('en-US')} VND)`;
            } else {
                // Hi·ªÉn th·ªã VND
                document.getElementById('lblGrandTotal').innerText = total.toLocaleString('en-US') + ' ƒë';
                document.getElementById('lblSubTotal').style.display = 'none';
            }
        }

        function luuBaoGia() {
            const data = {
                currency: currencyMode,
                rate: document.getElementById('txtTyGia').value,
                prices: {
                    dk: document.getElementById('priceDinhKy').value,
                    dh: document.getElementById('priceDocHai').value,
                    bnn: document.getElementById('priceBNN').value,
                    nu: document.getElementById('priceNu').value
                }
            };
            localStorage.setItem(`cost_${currentDotID}`, JSON.stringify(data));
            Swal.fire('ƒê√£ l∆∞u', 'C·∫•u h√¨nh gi√° ƒë√£ ƒë∆∞·ª£c l∆∞u cho ƒë·ª£t n√†y.', 'success');
        }

        function exportBaoGia() {
            const cur = currencyMode === 'USD' ? 'USD' : 'VND';
            const tyGia = document.getElementById('txtTyGia').value;
            
            let title = [["B·∫¢NG D·ª∞ TO√ÅN CHI PH√ç KH√ÅM S·ª®C KH·ªéE"]];
            let meta = [
                ["ƒê·ª£t kh√°m:", document.getElementById('modalTitle').innerText.replace("TH·ªêNG K√ä: ", "")],
                ["Lo·∫°i ti·ªÅn:", cur],
                ["Ng√†y xu·∫•t:", new Date().toLocaleDateString('vi-VN')]
            ];
            if(cur === 'USD') meta.push(["T·ª∑ gi√° √°p d·ª•ng:", tyGia + " VND/USD"]);

            let headers = [["H·∫°ng m·ª•c", "S·ªë l∆∞·ª£ng", "ƒê∆°n gi√° (" + cur + ")", "Th√†nh ti·ªÅn (" + cur + ")"]];
            
            let body = [
                ["1. Kh√°m ƒê·ªãnh K·ª≥", document.getElementById('qtyDinhKy').innerText, document.getElementById('priceDinhKy').value, document.getElementById('totalDinhKy').innerText],
                ["2. Kh√°m ƒê·ªôc H·∫°i", document.getElementById('qtyDocHai').innerText, document.getElementById('priceDocHai').value, document.getElementById('totalDocHai').innerText],
                ["3. Kh√°m BNN", document.getElementById('qtyBNN').innerText, document.getElementById('priceBNN').value, document.getElementById('totalBNN').innerText],
                ["4. Kh√°m Ph·ª• Khoa", document.getElementById('qtyNu').innerText, document.getElementById('priceNu').value, document.getElementById('totalNu').innerText],
                ["", "", "T·ªîNG C·ªòNG:", document.getElementById('lblGrandTotal').innerText]
            ];
            
            if(cur === 'USD') {
                body.push(["", "", "QUY ƒê·ªîI VND:", document.getElementById('lblSubTotal').innerText.replace("(Quy ƒë·ªïi: ‚âà ", "").replace(" VND)", "")]);
            }

            const ws = XLSX.utils.book_new();
            XLSX.utils.sheet_add_aoa(ws, title, {origin: "A1"});
            XLSX.utils.sheet_add_aoa(ws, meta, {origin: "A3"});
            XLSX.utils.sheet_add_aoa(ws, headers, {origin: "A8"});
            XLSX.utils.sheet_add_aoa(ws, body, {origin: "A9"});

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoGia");
            XLSX.writeFile(wb, "Du_Toan_Chi_Phi.xlsx");
        }

        // --- C√ÅC H√ÄM C≈® GI·ªÆ NGUY√äN ---
        async function vetTuDotCu(targetDotId) {
            const { data: listDot } = await supabaseClient.from('dot_kham').select('*').neq('id', targetDotId).order('id', {ascending: false});
            if(!listDot || listDot.length === 0) return Swal.fire('Th√¥ng b√°o', 'Ch∆∞a c√≥ ƒë·ª£t kh√°m c≈© n√†o.', 'info');
            const inputOptions = {}; listDot.forEach(d => inputOptions[d.id] = d.ten_dot);
            const { value: sourceDotId } = await Swal.fire({ title: 'Ch·ªçn ƒë·ª£t v√©t s√≥t', input: 'select', inputOptions: inputOptions, showCancelButton: true });
            if (sourceDotId) {
                document.getElementById('loadingOverlay').style.display = 'block';
                try {
                    const { data } = await supabaseClient.from('ho_so_kham').select('*').eq('dot_kham_id', sourceDotId).eq('trang_thai_checkin', false).range(0, 49999);
                    if(!data || data.length === 0) throw new Error("ƒê·ª£t n√†y ƒë√£ kh√°m h·∫øt!");
                    const newData = data.map(i => ({ dot_kham_id: targetDotId, ma_nv: i.ma_nv, bo_phan: i.bo_phan, vi_tri: i.vi_tri, phan_loai_lao_dong: i.phan_loai_lao_dong, chi_dinh_kham: i.chi_dinh_kham, trang_thai_checkin: false }));
                    const BATCH = 1000; for(let i=0; i<newData.length; i+=BATCH) await supabaseClient.from('ho_so_kham').upsert(newData.slice(i, i+BATCH), { onConflict: 'ma_nv, dot_kham_id', ignoreDuplicates: true });
                    document.getElementById('loadingOverlay').style.display = 'none'; Swal.fire('Xong', `ƒê√£ chuy·ªÉn ${newData.length} ng∆∞·ªùi.`, 'success'); loadDanhSach();
                } catch(e) { document.getElementById('loadingOverlay').style.display = 'none'; Swal.fire('L·ªói', e.message, 'error'); }
            }
        }

        async function lapDanhSach(dotId) {
             Swal.fire({ title: 'Qu√©t to√†n b·ªô?', text: "L·∫≠p danh s√°ch cho to√†n b·ªô nh√¢n vi√™n.", icon: 'info', showCancelButton: true, confirmButtonText: 'B·∫Øt ƒë·∫ßu' }).then(async (r) => {
                if(r.isConfirmed) {
                    const overlay = document.getElementById('loadingOverlay'); overlay.style.display = 'block';
                    try {
                        const [resCD, resCH] = await Promise.all([supabaseClient.from('danh_muc_cong_doan').select('*'), supabaseClient.from('cau_hinh_kham').select('*')]);
                        let mapCD = {}; resCD.data?.forEach(x => mapCD[x.ma_cong_doan] = x);
                        let mapCH = {}; resCH.data?.forEach(x => mapCH[x.ma_cong_doan] = x);
                        const { count: totalNV } = await supabaseClient.from('nhan_vien').select('*', { count: 'exact', head: true });
                        const PAGE_SIZE = 1000; let processedCount = 0;
                        for(let offset = 0; offset < totalNV; offset += PAGE_SIZE) {
                            const { data: batchNV } = await supabaseClient.from('nhan_vien').select('*').range(offset, offset + PAGE_SIZE - 1);
                            if(!batchNV || batchNV.length === 0) break;
                            const insertData = batchNV.map(nv => {
                                let isDocHai = mapCD[nv.ma_cong_doan]?.co_doc_hai ? 'ƒê·ªôc h·∫°i' : 'B√¨nh th∆∞·ªùng';
                                let chiDinh = []; let cfg = mapCH[nv.ma_cong_doan]?.chi_dinh_bnn;
                                if(cfg?.tl) chiDinh.push('Th√≠nh l·ª±c'); if(cfg?.hh) chiDinh.push('H√¥ h·∫•p');
                                return { dot_kham_id: dotId, ma_nv: nv.ma_nv, bo_phan: nv.ma_don_vi, vi_tri: nv.ma_chuc_vu, phan_loai_lao_dong: isDocHai, chi_dinh_kham: chiDinh.join(', '), trang_thai_checkin: false };
                            });
                            await supabaseClient.from('ho_so_kham').upsert(insertData, { onConflict: 'ma_nv, dot_kham_id', ignoreDuplicates: true });
                            processedCount += insertData.length;
                        }
                        overlay.style.display = 'none'; Swal.fire('Xong', `ƒê√£ c·∫≠p nh·∫≠t ${processedCount} ng∆∞·ªùi.`, 'success'); loadDanhSach();
                    } catch (err) { overlay.style.display = 'none'; Swal.fire('L·ªói', err.message, 'error'); }
                }
            });
        }
        
        async function xemThongKe(dotId, tenDot) {
            currentDotID = dotId;
            document.getElementById('modalTitle').innerText = "TH·ªêNG K√ä: " + tenDot;
            new bootstrap.Modal(document.getElementById('modalDetail')).show();

            const { count: cTong } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId);
            const { count: cDocHai } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId).eq('phan_loai_lao_dong', 'ƒê·ªôc h·∫°i');
            const { count: cBNN } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId).neq('chi_dinh_kham', '');
            const { count: cDaKham } = await supabaseClient.from('ho_so_kham').select('*', { count: 'exact', head: true }).eq('dot_kham_id', dotId).eq('trang_thai_checkin', true);

            document.getElementById('stTong').innerText = cTong || 0;
            document.getElementById('stDocHai').innerText = cDocHai || 0;
            document.getElementById('stBNN').innerText = cBNN || 0;
            document.getElementById('stDinhKy').innerText = ((cTong || 0) - (cDocHai || 0)) || 0;
            document.getElementById('stChuaKham').innerText = ((cTong || 0) - (cDaKham || 0)) || 0;
        }

        async function taiDanhSach(loai) {
            if(!currentDotID) return;
            const btn = event.target; const originalText = btn.innerHTML; btn.innerHTML = 'Loading...'; btn.disabled = true;
            try {
                const [resDV, resCV, resCD] = await Promise.all([supabaseClient.from('danh_muc_don_vi').select('*'), supabaseClient.from('danh_muc_chuc_vu').select('*'), supabaseClient.from('danh_muc_cong_doan').select('*')]);
                let mapDV = {}; resDV.data?.forEach(x => mapDV[x.ma_don_vi] = x.ten_don_vi);
                let mapCV = {}; resCV.data?.forEach(x => mapCV[x.ma_chuc_vu] = x.ten_chuc_vu);
                let mapCD = {}; resCD.data?.forEach(x => mapCD[x.ma_cong_doan] = x.ten_cong_doan);

                let allData = []; let offset = 0; const PAGE_SIZE = 2000; let keep = true;
                while(keep) {
                    let q = supabaseClient.from('ho_so_kham').select('ma_nv, bo_phan, vi_tri, phan_loai_lao_dong, chi_dinh_kham, trang_thai_checkin, nhan_vien(ho_ten, ma_cong_doan)').eq('dot_kham_id', currentDotID).range(offset, offset + PAGE_SIZE - 1);
                    if(loai === 'DOCHAI') q = q.eq('phan_loai_lao_dong', 'ƒê·ªôc h·∫°i');
                    else if(loai === 'BNN') q = q.neq('chi_dinh_kham', '');
                    else if(loai === 'MISSING') q = q.eq('trang_thai_checkin', false);
                    else if(loai === 'DINHKY') q = q.eq('phan_loai_lao_dong', 'B√¨nh th∆∞·ªùng');

                    const { data, error } = await q;
                    if(error) throw error;
                    if(data && data.length > 0) { allData = allData.concat(data); offset += PAGE_SIZE; if(data.length < PAGE_SIZE) keep = false; } else keep = false;
                }
                if(allData.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu.");

                const exportData = allData.map((item, idx) => ({
                    "STT": idx + 1, "M√£ NV": item.ma_nv, "H·ªç T√™n": item.nhan_vien?.ho_ten,
                    "M√£ ƒêV": item.bo_phan, "T√™n ƒê∆°n V·ªã": mapDV[item.bo_phan] || '',
                    "M√£ CV": item.vi_tri, "T√™n Ch·ª©c V·ª•": mapCV[item.vi_tri] || '',
                    "M√£ Cƒê": item.nhan_vien?.ma_cong_doan, "T√™n C√¥ng ƒêo·∫°n": mapCD[item.nhan_vien?.ma_cong_doan] || '',
                    "Ph√¢n Lo·∫°i": item.phan_loai_lao_dong, "Ch·ªâ ƒê·ªãnh": item.chi_dinh_kham,
                    "Tr·∫°ng Th√°i": item.trang_thai_checkin ? "ƒê√£ kh√°m" : "Ch∆∞a kh√°m"
                }));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData), "Data");
                XLSX.writeFile(wb, `DS_${loai}_KSK.xlsx`);
            } catch(e) { Swal.fire('L·ªói', e.message, 'error'); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        async function taoDotKham() {
            const ten = document.getElementById('txtTenDot').value; const ngay = document.getElementById('txtNgay').value || null;
            if(!ten) return Swal.fire('L·ªói', 'Nh·∫≠p t√™n', 'error');
            await supabaseClient.from('dot_kham').insert({ten_dot: ten, ngay_bat_dau: ngay}); loadDanhSach();
        }
        async function xoaDot(id) { if(confirm('X√≥a?')) { await supabaseClient.from('dot_kham').delete().eq('id', id); loadDanhSach(); } }
    </script>
</body>
</html>