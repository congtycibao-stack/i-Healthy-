<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE Report - Báo Cáo Sức Khỏe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .kpi-box { padding: 20px; border-radius: 10px; color: white; text-align: center; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-g1 { background: linear-gradient(45deg, #4e73df, #224abe); } /* Tổng */
        .bg-g2 { background: linear-gradient(45deg, #1cc88a, #13855c); } /* Định kỳ */
        .bg-g3 { background: linear-gradient(45deg, #f6c23e, #dda20a); color: #333; } /* BNN */
        .bg-g4 { background: linear-gradient(45deg, #e74a3b, #be2617); } /* Chưa khám */
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="fw-bold">Chọn Đợt Khám:</label>
                        <select id="selDotKham" class="form-select fw-bold border-primary" onchange="loadData()"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold text-success">Lọc theo Đơn Vị:</label>
                        <select id="selDonVi" class="form-select fw-bold text-success border-success" onchange="filterData()">
                            <option value="ALL">-- TOÀN CÔNG TY --</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                         <label class="small text-muted">Đơn giá ĐK (VNĐ)</label>
                         <input type="number" id="priceDK" class="form-control form-control-sm text-end" value="150000" onchange="renderTable()">
                    </div>
                    <div class="col-md-2">
                         <label class="small text-muted">Đơn giá BNN (VNĐ)</label>
                         <input type="number" id="priceBNN" class="form-control form-control-sm text-end" value="300000" onchange="renderTable()">
                    </div>
                    <div class="col-md-2">
                        <a href="index.html" class="btn btn-secondary w-100"><i class="bi bi-house"></i> Thoát</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2">Đang tải dữ liệu...</div></div>

        <div id="mainContent" style="display:none">
            <div class="row g-3 mb-4">
                <div class="col-md-3"><div class="kpi-box bg-g1"><h4>TỔNG NHÂN SỰ</h4><h1 class="display-4 fw-bold" id="kpiTotal">0</h1></div></div>
                <div class="col-md-3"><div class="kpi-box bg-g2"><h4>KHÁM ĐỊNH KỲ</h4><h1 class="display-4 fw-bold" id="kpiDK">0</h1><small>(NV Bình thường)</small></div></div>
                <div class="col-md-3"><div class="kpi-box bg-g3"><h4>KHÁM BNN</h4><h1 class="display-4 fw-bold" id="kpiBNN">0</h1><small>(NV Độc hại)</small></div></div>
                <div class="col-md-3"><div class="kpi-box bg-g4"><h4>CHƯA ĐI KHÁM</h4><h1 class="display-4 fw-bold" id="kpiMissing">0</h1><small>(Cần nhắc nhở)</small></div></div>
            </div>

            <div class="card shadow-sm border-primary mb-4">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-table"></i> BẢNG TỔNG HỢP & CHI PHÍ THEO ĐƠN VỊ
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 500px;">
                        <table class="table table-bordered table-hover mb-0 align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Đơn Vị / Bộ Phận</th>
                                    <th class="text-center">Tổng NV</th>
                                    <th class="text-center">Định Kỳ</th>
                                    <th class="text-center text-danger">Độc Hại (BNN)</th>
                                    <th class="text-center text-muted">Chưa Khám</th>
                                    <th class="text-end fw-bold text-success">Ước Tính Chi Phí</th>
                                    <th class="text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="tblMain"></tbody>
                            <tfoot class="table-light fw-bold">
                                <tr>
                                    <td>TỔNG CỘNG</td>
                                    <td class="text-center" id="tfTotal">0</td>
                                    <td class="text-center" id="tfDK">0</td>
                                    <td class="text-center" id="tfBNN">0</td>
                                    <td class="text-center" id="tfMissing">0</td>
                                    <td class="text-end text-success" id="tfCost">0 đ</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetail" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold" id="modalTitle">Chi Tiết Đơn Vị</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>Mã NV</th><th>Họ Tên</th><th>Loại Khám</th><th>Trạng Thái</th></tr></thead>
                        <tbody id="tblDetailBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);
        
        let rawData = [];
        let mapDonVi = {};
        let filteredData = []; // Dữ liệu sau khi lọc

        async function init() {
            const { data } = await supabaseClient.from('dot_kham').select('*').order('id', {ascending: false});
            const sel = document.getElementById('selDotKham');
            data?.forEach(d => { let opt = document.createElement('option'); opt.value = d.id; opt.text = d.ten_dot; sel.add(opt); });
            
            const { data: dv } = await supabaseClient.from('danh_muc_don_vi').select('*');
            dv?.forEach(i => mapDonVi[i.ma_don_vi] = i.ten_don_vi);

            loadData();
        }
        init();

        async function loadData() {
            const dotId = document.getElementById('selDotKham').value;
            if(!dotId) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';

            rawData = [];
            let offset = 0; const PAGE = 2000; let keep = true;
            while(keep) {
                const { data } = await supabaseClient.from('ho_so_kham')
                    .select('ma_nv, trang_thai_checkin, phan_loai_lao_dong, bo_phan, nhan_vien(ho_ten)')
                    .eq('dot_kham_id', dotId).range(offset, offset + PAGE - 1);
                if(data && data.length > 0) { rawData = rawData.concat(data); offset += PAGE; if(data.length < PAGE) keep = false; } else keep = false;
            }

            // Populate Filter
            const selDonVi = document.getElementById('selDonVi');
            selDonVi.innerHTML = '<option value="ALL">-- TOÀN CÔNG TY --</option>';
            const distinctDV = [...new Set(rawData.map(i => i.bo_phan))].sort();
            distinctDV.forEach(dv => {
                const name = mapDonVi[dv] || dv || 'Chưa xác định';
                let opt = document.createElement('option'); opt.value = dv; opt.text = name; selDonVi.add(opt);
            });

            filterData();
        }

        function filterData() {
            const selVal = document.getElementById('selDonVi').value;
            filteredData = (selVal === 'ALL') ? rawData : rawData.filter(i => i.bo_phan === selVal);

            // KPI TOP
            document.getElementById('kpiTotal').innerText = filteredData.length.toLocaleString();
            
            const dk = filteredData.filter(i => i.phan_loai_lao_dong !== 'Độc hại').length;
            const bnn = filteredData.filter(i => i.phan_loai_lao_dong === 'Độc hại').length;
            const missing = filteredData.filter(i => !i.trang_thai_checkin).length;

            document.getElementById('kpiDK').innerText = dk.toLocaleString();
            document.getElementById('kpiBNN').innerText = bnn.toLocaleString();
            document.getElementById('kpiMissing').innerText = missing.toLocaleString();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            renderTable();
        }

        function renderTable() {
            const pDK = parseInt(document.getElementById('priceDK').value) || 0;
            const pBNN = parseInt(document.getElementById('priceBNN').value) || 0;
            const tbody = document.getElementById('tblMain'); tbody.innerHTML = '';
            
            // Group by Unit
            let groups = {};
            filteredData.forEach(i => {
                const dvName = mapDonVi[i.bo_phan] || i.bo_phan || 'Khác';
                if(!groups[dvName]) groups[dvName] = { name: dvName, code: i.bo_phan, total: 0, dk: 0, bnn: 0, miss: 0, list: [] };
                
                groups[dvName].total++;
                groups[dvName].list.push(i);
                
                if(i.phan_loai_lao_dong === 'Độc hại') groups[dvName].bnn++;
                else groups[dvName].dk++;

                if(!i.trang_thai_checkin) groups[dvName].miss++;
            });

            // Render Rows
            let sumTotal=0, sumDK=0, sumBNN=0, sumMiss=0, sumCost=0;

            Object.values(groups).forEach(g => {
                const cost = (g.dk * pDK) + (g.bnn * pBNN);
                
                sumTotal += g.total; sumDK += g.dk; sumBNN += g.bnn; sumMiss += g.miss; sumCost += cost;

                tbody.innerHTML += `<tr>
                    <td>${g.name}</td>
                    <td class="text-center">${g.total}</td>
                    <td class="text-center">${g.dk}</td>
                    <td class="text-center">${g.bnn}</td>
                    <td class="text-center text-muted">${g.miss}</td>
                    <td class="text-end fw-bold">${cost.toLocaleString()}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-info" onclick='viewDetail("${g.name}")'><i class="bi bi-eye"></i></button>
                    </td>
                </tr>`;
            });

            // Update Footer
            document.getElementById('tfTotal').innerText = sumTotal.toLocaleString();
            document.getElementById('tfDK').innerText = sumDK.toLocaleString();
            document.getElementById('tfBNN').innerText = sumBNN.toLocaleString();
            document.getElementById('tfMissing').innerText = sumMiss.toLocaleString();
            document.getElementById('tfCost').innerText = sumCost.toLocaleString() + ' đ';

            // Store for modal access
            window.currentGroups = groups;
        }

        window.viewDetail = function(unitName) {
            const g = window.currentGroups[unitName];
            if(!g) return;
            document.getElementById('modalTitle').innerText = "Chi tiết: " + unitName;
            const tb = document.getElementById('tblDetailBody'); tb.innerHTML = '';
            
            g.list.forEach(i => {
                const type = i.phan_loai_lao_dong === 'Độc hại' ? '<span class="badge bg-danger">BNN</span>' : '<span class="badge bg-success">Định kỳ</span>';
                const stt = i.trang_thai_checkin ? '<span class="text-success">Đã khám</span>' : '<span class="text-secondary">Chưa khám</span>';
                tb.innerHTML += `<tr><td>${i.ma_nv}</td><td>${i.nhan_vien?.ho_ten}</td><td>${type}</td><td>${stt}</td></tr>`;
            });
            new bootstrap.Modal(document.getElementById('modalDetail')).show();
        }
    </script>
</body>
</html>