<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Chi Tiết - HSE CiBao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .kpi-box { padding: 20px; border-radius: 10px; color: white; text-align: center; height: 100%; }
        .bg-g1 { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-g2 { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-g3 { background: linear-gradient(45deg, #e74a3b, #be2617); }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h4 class="text-primary fw-bold mb-0">DASHBOARD SỨC KHỎE</h4>
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted fw-bold">Chọn Đợt Khám:</label>
                        <select id="selDotKham" class="form-select fw-bold" onchange="loadData()"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted fw-bold">Lọc theo Đơn vị / Bộ phận:</label>
                        <select id="selDonVi" class="form-select fw-bold text-success" onchange="filterData()">
                            <option value="ALL">-- TOÀN CÔNG TY --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2">Đang phân tích dữ liệu...</div></div>

        <div id="mainContent" style="display:none">
            <div class="row g-3 mb-4">
                <div class="col-md-4"><div class="kpi-box bg-g1"><h4>NHÂN SỰ (Trong phạm vi lọc)</h4><h1 class="display-4 fw-bold" id="kpiTotal">0</h1></div></div>
                <div class="col-md-4"><div class="kpi-box bg-g2"><h4>SỨC KHỎE TỐT (I, II)</h4><h1 class="display-4 fw-bold" id="kpiGood">0</h1></div></div>
                <div class="col-md-4"><div class="kpi-box bg-g3"><h4>SỨC KHỎE YẾU (IV, V)</h4><h1 class="display-4 fw-bold" id="kpiBad">0</h1></div></div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-lg-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header fw-bold text-primary">1. PHÂN BỐ LOẠI SỨC KHỎE</div>
                        <div class="card-body"><canvas id="chartLoai" height="200"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header fw-bold text-danger">2. TOP BỆNH LÝ PHỔ BIẾN (Tại đơn vị này)</div>
                        <div class="card-body"><canvas id="chartBenh" height="200"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="card h-100 shadow-sm border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">3. TÌNH HÌNH BỆNH NGHỀ NGHIỆP (ĐO ĐẠC)</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 text-center">
                                    <h5 class="fw-bold">THÍNH LỰC</h5>
                                    <canvas id="chartBNNTL" height="150"></canvas>
                                </div>
                                <div class="col-md-6 text-center">
                                    <h5 class="fw-bold">HÔ HẤP</h5>
                                    <canvas id="chartBNNHH" height="150"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const projectUrl = 'https://eoebiveebosvlyndbdak.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZWJpdmVlYm9zdmx5bmRiZGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjI4NjEsImV4cCI6MjA4MzMzODg2MX0.dF5-AmjWlxtJSD2QWHFpiWpHE8l6cHuG_pLxkXD-TUc';
        const supabaseClient = window.supabase.createClient(projectUrl, projectKey);

        let rawData = []; // Chứa toàn bộ dữ liệu gốc
        let mapDonVi = {};
        let charts = {}; // Lưu các instance biểu đồ

        async function init() {
            // Load Đợt
            const { data } = await supabaseClient.from('dot_kham').select('*').order('id', {ascending: false});
            const sel = document.getElementById('selDotKham');
            data?.forEach(d => { let opt = document.createElement('option'); opt.value = d.id; opt.text = d.ten_dot; sel.add(opt); });
            
            // Load Từ điển Đơn vị
            const { data: dv } = await supabaseClient.from('danh_muc_don_vi').select('*');
            dv?.forEach(i => mapDonVi[i.ma_don_vi] = i.ten_don_vi);

            loadData();
        }
        init();

        async function loadData() {
            const dotId = document.getElementById('selDotKham').value;
            if(!dotId) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';

            // Fetch Data (Loop)
            rawData = [];
            let offset = 0; const PAGE = 2000; let keep = true;
            while(keep) {
                const { data, error } = await supabaseClient
                    .from('ho_so_kham')
                    .select('xep_loai, ket_luan_benh, bo_phan, ket_qua_thinh_luc, ket_qua_ho_hap')
                    .eq('dot_kham_id', dotId)
                    .range(offset, offset + PAGE - 1);
                
                if(data && data.length > 0) { rawData = rawData.concat(data); offset += PAGE; if(data.length < PAGE) keep = false; } else keep = false;
            }

            // Populate Filter Đơn Vị
            const selDonVi = document.getElementById('selDonVi');
            selDonVi.innerHTML = '<option value="ALL">-- TOÀN CÔNG TY --</option>';
            const distinctDV = [...new Set(rawData.map(i => i.bo_phan))].sort();
            distinctDV.forEach(dv => {
                const name = mapDonVi[dv] || dv || 'Chưa xác định';
                let opt = document.createElement('option');
                opt.value = dv; opt.text = name; selDonVi.add(opt);
            });

            filterData();
        }

        function filterData() {
            const selectedDV = document.getElementById('selDonVi').value;
            
            // Lọc dữ liệu
            let filtered = (selectedDV === 'ALL') ? rawData : rawData.filter(i => i.bo_phan === selectedDV);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // --- 1. KPI ---
            let good=0, bad=0, med=0;
            let benhMap = {};
            let bnn = { tl_ok:0, tl_fail:0, hh_ok:0, hh_fail:0 };

            filtered.forEach(d => {
                // Sức khỏe
                let l = d.xep_loai ? d.xep_loai.toString() : '0';
                if(['1','2','I','II'].includes(l)) good++;
                else if(['3','III'].includes(l)) med++;
                else if(['4','5','IV','V'].includes(l)) bad++;

                // Bệnh
                if(d.ket_luan_benh) {
                    d.ket_luan_benh.split(/[;,]/).forEach(b => {
                        let bk = b.trim(); if(bk.length>2 && bk.toLowerCase()!='bình thường') benhMap[bk] = (benhMap[bk]||0)+1;
                    });
                }

                // BNN
                // Thính lực: Check chữ "giảm", "điếc"
                if(d.ket_qua_thinh_luc) {
                    if(d.ket_qua_thinh_luc.toLowerCase().match(/giảm|điếc/)) bnn.tl_fail++; else bnn.tl_ok++;
                }
                // Hô hấp: Check "hạn chế", "tắc nghẽn"
                if(d.ket_qua_ho_hap) {
                    if(d.ket_qua_ho_hap.toLowerCase().match(/hạn chế|tắc nghẽn/)) bnn.hh_fail++; else bnn.hh_ok++;
                }
            });

            document.getElementById('kpiTotal').innerText = filtered.length.toLocaleString();
            document.getElementById('kpiGood').innerText = good.toLocaleString();
            document.getElementById('kpiBad').innerText = bad.toLocaleString();

            // --- 2. RENDER CHARTS ---
            renderPie('chartLoai', [good, med, bad], ['Tốt', 'TB', 'Yếu']);
            
            const topBenh = Object.entries(benhMap).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            renderBar('chartBenh', topBenh);

            renderDoughnut('chartBNNTL', [bnn.tl_ok, bnn.tl_fail], ['Bình thường', 'Suy giảm']);
            renderDoughnut('chartBNNHH', [bnn.hh_ok, bnn.hh_fail], ['Bình thường', 'Suy giảm']);
        }

        // --- CHART HELPERS ---
        function renderPie(id, data, labels) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'pie',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#198754', '#ffc107', '#dc3545'] }] }
            });
        }
        function renderBar(id, dataArr) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar',
                data: { labels: dataArr.map(x=>x[0]), datasets: [{ label: 'Số ca', data: dataArr.map(x=>x[1]), backgroundColor: '#0d6efd' }] },
                options: { indexAxis: 'y' }
            });
        }
        function renderDoughnut(id, data, labels) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#198754', '#dc3545'] }] }
            });
        }
    </script>
</body>
</html>